{% extends 'base.html' %}

{% block title %}Portfolio Analyzer{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Portfolio Analyzer</h2>
    <p class="text-gray-600 dark:text-gray-400 mb-4">Select a Client ID to view their portfolio analysis.</p>

    <select id="client-selector" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors">
        <option value="" disabled {% if not results %}selected{% endif %}>-- Select a Client ID --</option>
        {% for client_id in client_ids %}
            <option value="{{ client_id }}" {% if selected_client_id == client_id %}selected{% endif %}>{{ client_id }}</option>
        {% endfor %}
    </select>
</div>

{% if results %}
    <div class="mb-6"><p class="text-gray-600 dark:text-gray-300">Displaying analysis for Client: <span class="font-semibold text-gray-800 dark:text-white">{{ selected_client_id }}</span></p></div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center transition-colors"><h4 class="font-semibold text-gray-700 dark:text-gray-300">Fund Overlap Score</h4><p class="text-4xl font-bold text-blue-600 dark:text-blue-400 my-2">{{ results.overlap_score|round(1) }}<span class="text-2xl text-gray-500 dark:text-gray-400">/100</span></p><p class="text-xs text-gray-500 dark:text-gray-400">Higher is better.</p></div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center transition-colors"><h4 class="font-semibold text-gray-700 dark:text-gray-300">Sector Score</h4><p class="text-4xl font-bold text-green-600 dark:text-green-400 my-2">{{ results.sector_score|round(1) }}<span class="text-2xl text-gray-500 dark:text-gray-400">/100</span></p><p class="text-xs text-gray-500 dark:text-gray-400">Higher is better.</p></div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center border-2 border-indigo-600 dark:border-indigo-400 transition-colors"><h4 class="font-semibold text-indigo-700 dark:text-indigo-300">Final Diversification Score</h4><p class="text-4xl font-bold text-indigo-600 dark:text-indigo-400 my-2">{{ results.final_score|round(1) }}<span class="text-2xl text-gray-500 dark:text-gray-400">/100</span></p><p class="text-xs text-gray-500 dark:text-gray-400">A combined measure.</p></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow transition-colors">
                <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100 mb-4">Overall Sector Exposure</h3>
                 <div class="flex flex-col md:flex-row gap-6 items-center">
                    
                    {% set circumference = 2 * 22/7 * 15.9155 %}
                    {% set offset = 0 %}
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="15.9155" fill="none" class="stroke-current text-gray-200 dark:text-gray-700" stroke-width="3.8"></circle>
                            {% for sector in results.sector_data %}
                                {% set weight_percent = sector.weight * 100 %}
                                <circle cx="18" cy="18" r="15.9155" fill="none" class="stroke-current"
                                    stroke-width="3.8"
                                    stroke-dasharray="{{ weight_percent * circumference / 100 }}, {{ circumference }}"
                                    stroke-dashoffset="-{{ offset }}"
                                    style="color: whitesmoke">
                                </circle>
                                {% set offset = offset + (weight_percent * circumference / 100) %}
                            {% endfor %}
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span class="text-3xl font-bold dark:text-white">{{ results.final_score|round(0) }}</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Score</span>
                        </div>
                    </div>

                    <div class="flex-1 w-full">
                        <h4 class="font-semibold mb-2 dark:text-white">Sector Mix</h4>
                        <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                            {% for sector in results.sector_data %}
                            <li class="flex items-center justify-between">
                                <span><span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color:whitesmoke"></span>{{ sector.name }}</span>
                                <span class="font-medium text-gray-800 dark:text-gray-100">{{ (sector.weight * 100)|round(1) }}%</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow transition-colors">
                <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100">Risk Level</h3>
                <span class="text-sm font-medium px-2 py-1 rounded-full {{ results.risk_info.badge_color }}">
                    {{ results.risk_info.level }}
                </span>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Diversification Score</p>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1">
                    <div class="h-2.5 rounded-full transition-all duration-500 {{ results.risk_info.bar_color }}" style="width: 100"></div>
                </div>
                <p class="text-right font-bold text-gray-700 dark:text-gray-300">{{ results.final_score|round(1) }}/100</p>
            </div>
        </div>
    </div>
{% endif %}

<script>
    document.getElementById('client-selector').addEventListener('change', function() {
        if (this.value) {
            window.location.href = '/portfolio/' + this.value;
        }
    });
</script>
{% endblock %}