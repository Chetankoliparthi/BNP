{% extends 'base.html' %}

{% block title %}Enter Portfolio Data{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Analyze Your Portfolio</h2>
    <p class="text-gray-600 mb-6">Choose an input method below to calculate your portfolio's diversification score.</p>

    <div class="border-b border-gray-200">
        <nav class="flex space-x-4" aria-label="Tabs">
            <button id="tab-form" onclick="switchTab('form')" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-blue-600 text-blue-600">Step-by-Step Form</button>
            <button id="tab-json" onclick="switchTab('json')" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent text-gray-500 hover:text-gray-700">Paste JSON Data</button>
        </nav>
    </div>

    <form id="portfolio-form" action="/analyze-portfolio" method="POST" class="mt-6">
        <input type="hidden" id="input_method" name="input_method" value="form">
        
        <div id="container-form">
            <div class="mb-6">
                <label for="num_funds" class="block text-sm font-medium text-gray-700">How many funds do you have?</label>
                <input type="number" id="num_funds" name="num_funds" min="1" class="mt-1 block w-full md:w-1/4 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div id="funds-container" class="space-y-8"></div>
        </div>

        <div id="container-json" class="hidden">
            <label for="json_data" class="block text-sm font-medium text-gray-700">Paste your portfolio JSON here:</label>
            <textarea id="json_data" name="json_data" rows="15" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm font-mono text-sm"></textarea>
        </div>

        <div class="mt-8">
            <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-md hover:bg-blue-700">Analyze My Portfolio</button>
        </div>
    </form>
    
    {% if error %}
      <div class="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ error }}</span>
      </div>
    {% endif %}
</div>

<script>
    // --- Script for dynamic form ---
    // (This part is the same as before)
    document.getElementById('num_funds').addEventListener('change', function(e) { /* ... same code as before ... */ });
    let holdingCounters = {};
    function addHolding(fundIndex) { /* ... same code as before ... */ }
    
    // --- New script for Tab Switching ---
    function switchTab(tab) {
        const formContainer = document.getElementById('container-form');
        const jsonContainer = document.getElementById('container-json');
        const tabForm = document.getElementById('tab-form');
        const tabJson = document.getElementById('tab-json');
        const inputMethod = document.getElementById('input_method');

        if (tab === 'json') {
            formContainer.classList.add('hidden');
            jsonContainer.classList.remove('hidden');
            tabJson.classList.add('border-blue-600', 'text-blue-600');
            tabJson.classList.remove('border-transparent', 'text-gray-500');
            tabForm.classList.remove('border-blue-600', 'text-blue-600');
            tabForm.classList.add('border-transparent', 'text-gray-500');
            inputMethod.value = 'json';
        } else { // 'form' tab
            jsonContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
            tabForm.classList.add('border-blue-600', 'text-blue-600');
            tabForm.classList.remove('border-transparent', 'text-gray-500');
            tabJson.classList.remove('border-blue-600', 'text-blue-600');
            tabJson.classList.add('border-transparent', 'text-gray-500');
            inputMethod.value = 'form';
        }
    }
    
    // --- Paste the full JavaScript functions from the previous step here ---
    document.getElementById('num_funds').addEventListener('change', function(e) {
        const numFunds = parseInt(e.target.value, 10);
        const container = document.getElementById('funds-container');
        container.innerHTML = '';
        if (isNaN(numFunds) || numFunds < 1) return;
        for (let i = 0; i < numFunds; i++) {
            const fundIndex = i;
            const fundDiv = document.createElement('div');
            fundDiv.className = 'border border-gray-200 p-4 rounded-lg';
            fundDiv.innerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">Fund ${fundIndex + 1}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="fund-${fundIndex}-amount" class="block text-sm font-medium text-gray-700">Fund Amount</label><input type="number" name="fund-${fundIndex}-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div></div><div id="holdings-container-${fundIndex}" class="mt-4 space-y-2"><h4 class="text-md font-medium text-gray-700">Holdings</h4></div><button type="button" onclick="addHolding(${fundIndex})" class="mt-2 text-sm text-blue-600 font-semibold hover:text-blue-800">+ Add Holding</button>`;
            container.appendChild(fundDiv);
            addHolding(fundIndex);
        }
    });
    function addHolding(fundIndex) {
        if (holdingCounters[fundIndex] === undefined) holdingCounters[fundIndex] = 0;
        const holdingIndex = holdingCounters[fundIndex];
        const container = document.getElementById(`holdings-container-${fundIndex}`);
        const holdingDiv = document.createElement('div');
        holdingDiv.className = 'grid grid-cols-2 gap-2 items-center';
        holdingDiv.innerHTML = `<input type="text" name="fund-${fundIndex}-holding-${holdingIndex}-ticker" placeholder="Ticker (e.g., INFY)" class="block w-full rounded-md border-gray-300 shadow-sm" required><input type="number" step="0.01" name="fund-${fundIndex}-holding-${holdingIndex}-weight" placeholder="Weight (e.g., 0.30)" class="block w-full rounded-md border-gray-300 shadow-sm" required>`;
        container.appendChild(holdingDiv);
        holdingCounters[fundIndex]++;
    }
</script>
{% endblock %}